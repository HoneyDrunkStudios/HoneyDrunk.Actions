# ==============================================================================
# PR Core Workflow
# ==============================================================================
# Purpose:
#   Fast, minimal PR validation for most repos in the HoneyDrunk Grid.
#   Designed to be a required check that provides quick feedback on PRs.
#
# Responsibilities:
#   - Orchestrate build, test, and analysis jobs
#   - Coordinate PR validation workflow
#   - Generate PR summary
#
# Single Responsibility:
#   Orchestration only - delegates to job-level workflows
#
# Non-goals:
#   - Deep security scans (use nightly-security.yml)
#   - Full site crawls (use nightly-accessibility.yml)
#   - Organization-wide checks (use weekly-governance.yml)
#
# Triggers:
#   - This workflow is reusable via workflow_call
#   - Consuming repos should trigger it on pull_request events
#
# Usage Example:
#   See docs/consumer-usage.md for sample consumer workflows
# ==============================================================================

name: PR Core

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: 'The .NET SDK version to use'
        required: false
        type: string
        default: '10.0.x'
      
      configuration:
        description: 'Build configuration (Debug or Release)'
        required: false
        type: string
        default: 'Release'
      
      runs-on:
        description: 'GitHub runner to use (ubuntu-latest, windows-latest, macos-latest)'
        required: false
        type: string
        default: 'ubuntu-latest'
      
      working-directory:
        description: 'Working directory for all operations'
        required: false
        type: string
        default: '.'
      
      project-path:
        description: 'Path to solution or project file (auto-detected if not specified)'
        required: false
        type: string
        default: ''
      
      enable-secret-scan:
        description: 'Run secret scanning on PR diff'
        required: false
        type: boolean
        default: true
      
      enable-accessibility-check:
        description: 'Run minimal accessibility check (opt-in)'
        required: false
        type: boolean
        default: false
      
      accessibility-url:
        description: 'URL to check for accessibility (required if enable-accessibility-check is true)'
        required: false
        type: string
        default: ''
      
      post-pr-summary:
        description: 'Post results summary to PR as comment'
        required: false
        type: boolean
        default: true
      
      actions-ref:
        description: 'Git ref of HoneyDrunk.Actions to use (main, tag, or commit)'
        required: false
        type: string
        default: 'main'
    
    secrets:
      github-token:
        description: 'GitHub token for PR comments and API access'
        required: false

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test
    uses: HoneyDrunkStudios/HoneyDrunk.Actions/.github/workflows/job-build-and-test.yml@main
    with:
      dotnet-version: ${{ inputs.dotnet-version }}
      configuration: ${{ inputs.configuration }}
      runs-on: ${{ inputs.runs-on }}
      working-directory: ${{ inputs.working-directory }}
      project-path: ${{ inputs.project-path }}
      enable-cache: true
      collect-coverage: true
      actions-ref: ${{ inputs.actions-ref }}
    permissions:
      contents: read
      checks: write
  
  # Job 2: Static Analysis
  static-analysis:
    name: Static Analysis
    uses: HoneyDrunkStudios/HoneyDrunk.Actions/.github/workflows/job-static-analysis.yml@main
    with:
      dotnet-version: ${{ inputs.dotnet-version }}
      runs-on: ${{ inputs.runs-on }}
      working-directory: ${{ inputs.working-directory }}
      project-path: ${{ inputs.project-path }}
      check-formatting: true
      fail-on-formatting-issues: false  # Warn only in PR
      fail-on-severity: 'high'
      validate-test-naming: true
      actions-ref: ${{ inputs.actions-ref }}
    permissions:
      contents: read
  
  # Job 3: Secret Scan (Optional)
  secret-scan:
    name: Secret Scan (Diff Only)
    if: ${{ inputs.enable-secret-scan }}
    uses: HoneyDrunkStudios/HoneyDrunk.Actions/.github/workflows/job-secret-scan.yml@main
    with:
      runs-on: ${{ inputs.runs-on }}
      scan-mode: 'diff-only'
    permissions:
      contents: read
  
  # Job 4: Accessibility Check (Optional)
  accessibility-check:
    name: Minimal Accessibility Check
    if: ${{ inputs.enable-accessibility-check }}
    runs-on: ${{ inputs.runs-on }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate accessibility URL provided
        if: ${{ inputs.accessibility-url == '' }}
        shell: bash
        run: |
          echo "::error::accessibility-url input is required when enable-accessibility-check is true"
          exit 1
      
      - name: Run minimal accessibility check
        shell: bash
        run: |
          echo "Running minimal accessibility check on: ${{ inputs.accessibility-url }}"
          echo "This is a placeholder for HoneyDrunk.Tools accessibility scanning CLI"
          echo "Command: hd-tools accessibility scan --url ${{ inputs.accessibility-url }} --minimal"
          echo "::notice::Accessibility scanning will be implemented via HoneyDrunk.Tools CLI"
          
          # Placeholder exit - replace with actual tool invocation
          # hd-tools accessibility scan --url "${{ inputs.accessibility-url }}" --minimal
  
  # Job 5: PR Summary
  pr-summary:
    name: PR Summary
    needs: [build-and-test, static-analysis, secret-scan]
    if: ${{ always() && inputs.post-pr-summary }}
    runs-on: ${{ inputs.runs-on }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Checkout HoneyDrunk.Actions
        uses: actions/checkout@v4
        with:
          repository: HoneyDrunkStudios/HoneyDrunk.Actions
          path: .github/actions-repo
          ref: ${{ inputs.actions-ref }}
      
      - name: Download test results artifact (if exists)
        uses: actions/download-artifact@v4
        with:
          name: test-results-${{ inputs.runs-on }}
          path: TestResults
        continue-on-error: true
      
      - name: Download coverage reports artifact (if exists)
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports-${{ inputs.runs-on }}
          path: TestResults
        continue-on-error: true
      
      - name: Generate PR summary
        id: gen
        uses: ./.github/actions-repo/.github/actions/pr/generate-summary
        with:
          test-results-directory: TestResults
          build-status: ${{ needs.build-and-test.result == 'success' && 'success' || 'failure' }}
          include-coverage: 'true'
      
      - name: Determine overall status
        id: status
        shell: bash
        run: |
          # Check if any job failed
          BUILD_RESULT="${{ needs.build-and-test.result }}"
          ANALYSIS_RESULT="${{ needs.static-analysis.result }}"
          SECRETS_RESULT="${{ needs.secret-scan.result }}"
          
          # Collect warnings - use empty defaults for skipped jobs
          BUILD_WARNINGS="${{ needs.build-and-test.outputs.has-warnings }}"
          ANALYSIS_WARNINGS="${{ needs.static-analysis.outputs.has-warnings }}"
          SECRETS_WARNINGS="${{ needs.secret-scan.outputs.has-warnings || 'false' }}"
          
          BUILD_WARNING_MSG="${{ needs.build-and-test.outputs.warning-messages }}"
          ANALYSIS_WARNING_MSG="${{ needs.static-analysis.outputs.warning-messages }}"
          SECRETS_WARNING_MSG="${{ needs.secret-scan.outputs.warning-messages }}"
          
          # Determine status - don't fail on skipped jobs
          if [[ "$BUILD_RESULT" == "failure" || "$ANALYSIS_RESULT" == "failure" || "$SECRETS_RESULT" == "failure" ]]; then
            echo "icon=:x:" >> $GITHUB_OUTPUT
            echo "status=Failed" >> $GITHUB_OUTPUT
          elif [[ "$BUILD_WARNINGS" == "true" || "$ANALYSIS_WARNINGS" == "true" || "$SECRETS_WARNINGS" == "true" ]]; then
            echo "icon=:warning:" >> $GITHUB_OUTPUT
            echo "status=Passed with Warnings" >> $GITHUB_OUTPUT
          else
            echo "icon=:white_check_mark:" >> $GITHUB_OUTPUT
            echo "status=Success" >> $GITHUB_OUTPUT
          fi
          
          # Build warnings section
          WARNINGS_SECTION=""
          if [[ "$BUILD_WARNINGS" == "true" && -n "$BUILD_WARNING_MSG" ]]; then
            WARNINGS_SECTION="${WARNINGS_SECTION}
          - :warning: **Build & Test:** $BUILD_WARNING_MSG"
          fi
          if [[ "$ANALYSIS_WARNINGS" == "true" && -n "$ANALYSIS_WARNING_MSG" ]]; then
            WARNINGS_SECTION="${WARNINGS_SECTION}
          - :warning: **Static Analysis:** $ANALYSIS_WARNING_MSG"
          fi
          if [[ "$SECRETS_WARNINGS" == "true" && -n "$SECRETS_WARNING_MSG" ]]; then
            WARNINGS_SECTION="${WARNINGS_SECTION}
          - :warning: **Secret Scan:** $SECRETS_WARNING_MSG"
          fi
          
          # Save to output
          {
            echo "warnings<<EOF"
            echo "$WARNINGS_SECTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT
      
      - name: Build summary message
        id: message
        env:
          BASE_MARKDOWN: ${{ steps.gen.outputs.markdown }}
          JOB_BUILD_RESULT: ${{ needs.build-and-test.result }}
          JOB_STATIC_RESULT: ${{ needs.static-analysis.result }}
          JOB_SECRET_RESULT: ${{ needs.secret-scan.result }}
          WARNINGS_BLOCK: ${{ steps.status.outputs.warnings }}
          BUILD_CONFIGURATION: ${{ inputs.configuration }}
          RUNS_ON: ${{ inputs.runs-on }}
          COMMIT_SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        shell: bash
        run: |
          set -euo pipefail
          # Persist base markdown from env var safely
          printf "%s" "$BASE_MARKDOWN" > message.md

          {
            echo ""
            echo "### Job Results"
            echo "- **Build and Test:** $JOB_BUILD_RESULT"
            echo "- **Static Analysis:** $JOB_STATIC_RESULT"
          } >> message.md

          if [ "$JOB_SECRET_RESULT" != "skipped" ]; then
            echo "- **Secret Scan:** $JOB_SECRET_RESULT" >> message.md
          fi

          if [ -n "$WARNINGS_BLOCK" ]; then
            {
              echo ""
              echo "### Warnings"
              echo "$WARNINGS_BLOCK"
            } >> message.md
          fi

          {
            echo ""
            echo "### Configuration"
            echo "- **Build Configuration:** $BUILD_CONFIGURATION"
            echo "- **Runner:** $RUNS_ON"
            echo "- **Commit:** \`$COMMIT_SHA\`"
            echo ""
            echo "---"
            echo "_View detailed logs in the [workflow run]($RUN_URL)_"
          } >> message.md

          {
            echo "text<<EOF"
            cat message.md
            echo "EOF"
          } >> $GITHUB_OUTPUT
      
      - name: Write summary to GitHub
        shell: bash
        run: |
          echo "${{ steps.message.outputs.text }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Post PR comment
        continue-on-error: true
        uses: ./.github/actions-repo/.github/actions/pr/post-comment
        with:
          github-token: ${{ secrets.github-token || github.token }}
          message: ${{ steps.message.outputs.text }}
