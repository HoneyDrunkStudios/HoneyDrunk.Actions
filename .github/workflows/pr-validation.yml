name: PR Validation (Reusable)

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: 'The .NET SDK version to use'
        required: false
        type: string
        default: '10.0.x'
      configuration:
        description: 'Build configuration'
        required: false
        type: string
        default: 'Release'
      runs-on:
        description: 'The runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      working-directory:
        description: 'Working directory for operations'
        required: false
        type: string
        default: '.'
      enable-code-quality:
        description: 'Run code quality checks'
        required: false
        type: boolean
        default: true
      post-pr-comment:
        description: 'Post results as PR comment'
        required: false
        type: boolean
        default: false
      actions-ref:
        description: 'Git ref (branch/tag/commit) of HoneyDrunk.Actions to use'
        required: false
        type: string
        default: 'main'
    secrets:
      github-token:
        description: 'GitHub token for posting comments'
        required: false

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ inputs.runs-on }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Checkout HoneyDrunk.Actions
        uses: actions/checkout@v4
        with:
          repository: HoneyDrunkStudios/HoneyDrunk.Actions
          path: .github/actions-repo
          ref: ${{ inputs.actions-ref }}
      
      - name: Setup .NET
        uses: ./.github/actions-repo/.github/actions/dotnet/setup
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
      
      - name: Setup NuGet cache
        uses: ./.github/actions-repo/.github/actions/nuget/setup-cache
        with:
          working-directory: ${{ inputs.working-directory }}
      
      - name: Restore dependencies
        uses: ./.github/actions-repo/.github/actions/dotnet/restore
        with:
          working-directory: ${{ inputs.working-directory }}
      
      - name: Build solution
        uses: ./.github/actions-repo/.github/actions/dotnet/build
        with:
          configuration: ${{ inputs.configuration }}
          no-restore: 'true'
          working-directory: ${{ inputs.working-directory }}
      
      - name: Run tests
        continue-on-error: false
        uses: ./.github/actions-repo/.github/actions/dotnet/test
        with:
          configuration: ${{ inputs.configuration }}
          no-build: 'true'
          collect-coverage: 'true'
          working-directory: ${{ inputs.working-directory }}
      
      - name: Publish test results
        if: always()
        continue-on-error: true
        uses: ./.github/actions-repo/.github/actions/diagnostics/publish-test-results
        with:
          test-results-directory: ${{ inputs.working-directory }}/TestResults
          github-token: ${{ secrets.github-token || github.token }}

      - name: Upload test results
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.runs-on }}
          path: ${{ inputs.working-directory }}/TestResults/**/*
          retention-days: 30
      
      - name: Upload coverage reports
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ inputs.runs-on }}
          path: ${{ inputs.working-directory }}/TestResults/**/coverage.cobertura.xml
          retention-days: 30
  
  code-quality:
    name: Code Quality
    if: ${{ inputs.enable-code-quality }}
    runs-on: ${{ inputs.runs-on }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Checkout HoneyDrunk.Actions
        uses: actions/checkout@v4
        with:
          repository: HoneyDrunkStudios/HoneyDrunk.Actions
          path: .github/actions-repo
          ref: ${{ inputs.actions-ref }}
      
      - name: Setup .NET
        uses: ./.github/actions-repo/.github/actions/dotnet/setup
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
      
      - name: Restore dependencies
        uses: ./.github/actions-repo/.github/actions/dotnet/restore
        with:
          working-directory: ${{ inputs.working-directory }}
      
      - name: Security vulnerability scan
        uses: ./.github/actions-repo/.github/actions/security/vulnerability-scan
        with:
          working-directory: ${{ inputs.working-directory }}
          fail-on-severity: 'moderate'
      
      - name: Validate test naming
        continue-on-error: true
        uses: ./.github/actions-repo/.github/actions/diagnostics/validate-test-naming
        with:
          test-directory: ${{ inputs.working-directory }}
      
      - name: Check formatting (warn only)
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          dotnet format --verify-no-changes --verbosity diagnostic || echo "::warning::Code formatting issues detected. Run 'dotnet format' to fix."
  
  pr-summary:
    name: PR Summary
    needs: [build-and-test, code-quality]
    if: ${{ always() && github.event_name == 'pull_request' }}
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Checkout HoneyDrunk.Actions
        uses: actions/checkout@v4
        with:
          repository: HoneyDrunkStudios/HoneyDrunk.Actions
          path: .github/actions-repo
          ref: ${{ inputs.actions-ref }}
      
      - name: Generate PR summary
        continue-on-error: true
        uses: ./.github/actions-repo/.github/actions/pr/generate-summary
      
      - name: Post PR comment
        if: ${{ inputs.post-pr-comment }}
        continue-on-error: true
        uses: ./.github/actions-repo/.github/actions/pr/post-comment
        with:
          github-token: ${{ secrets.github-token }}
          message: |
            ## :white_check_mark: PR Validation Complete
            
            Build and tests completed successfully!
            
            **Configuration:** ${{ inputs.configuration }}
            **Runner:** ${{ inputs.runs-on }}
            **Commit:** `${{ github.sha }}`
