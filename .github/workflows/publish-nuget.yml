name: Publish NuGet Package (Reusable)

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: 'The .NET SDK version to use'
        required: false
        type: string
        default: '10.0.x'
      configuration:
        description: 'Build configuration'
        required: false
        type: string
        default: 'Release'
      runs-on:
        description: 'The runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      working-directory:
        description: 'Working directory for operations'
        required: false
        type: string
        default: '.'
      project-path:
        description: 'Path to the project to pack'
        required: false
        type: string
        default: '.'
      nuget-source:
        description: 'NuGet feed URL'
        required: false
        type: string
        default: 'https://api.nuget.org/v3/index.json'
      skip-duplicate:
        description: 'Skip if package version already exists'
        required: false
        type: boolean
        default: true
      actions-ref:
        description: 'Git ref (branch/tag/commit) of HoneyDrunk.Actions to use'
        required: false
        type: string
        default: 'main'
    secrets:
      nuget-api-key:
        description: 'API key for the NuGet feed'
        required: true

permissions:
  contents: read
  packages: write

jobs:
  publish:
    name: Publish Package
    runs-on: ${{ inputs.runs-on }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Checkout HoneyDrunk.Actions
        uses: actions/checkout@v4
        with:
          repository: HoneyDrunkStudios/HoneyDrunk.Actions
          path: .github/actions-repo
          ref: ${{ inputs.actions-ref }}
      
      - name: Setup .NET
        uses: ./.github/actions-repo/.github/actions/dotnet/setup
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
      
      - name: Restore dependencies
        uses: ./.github/actions-repo/.github/actions/dotnet/restore
        with:
          working-directory: ${{ inputs.working-directory }}
      
      - name: Build project
        uses: ./.github/actions-repo/.github/actions/dotnet/build
        with:
          configuration: ${{ inputs.configuration }}
          no-restore: 'true'
          working-directory: ${{ inputs.working-directory }}
      
      - name: Pack project
        uses: ./.github/actions-repo/.github/actions/dotnet/pack
        with:
          project-path: ${{ inputs.project-path }}
          configuration: ${{ inputs.configuration }}
          no-build: 'true'
          output-directory: ./artifacts
          working-directory: ${{ inputs.working-directory }}
      
      - name: Push to NuGet
        uses: ./.github/actions-repo/.github/actions/nuget/push
        with:
          package-path: './artifacts/*.nupkg'
          source: ${{ inputs.nuget-source }}
          api-key: ${{ secrets.nuget-api-key }}
          skip-duplicate: ${{ inputs.skip-duplicate }}
          working-directory: ${{ inputs.working-directory }}
      
      - name: Upload packages
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ${{ inputs.working-directory }}/artifacts/*.nupkg
          retention-days: 90
