name: Code Quality Check

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: 'The .NET SDK version to use'
        required: false
        type: string
        default: '10.0.x'
      runs-on:
        description: 'The runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      working-directory:
        description: 'Working directory for operations'
        required: false
        type: string
        default: '.'
      fail-on-severity:
        description: 'Minimum vulnerability severity to fail (low, moderate, high, critical)'
        required: false
        type: string
        default: 'moderate'
      validate-test-naming:
        description: 'Validate test file naming conventions'
        required: false
        type: boolean
        default: true
      check-formatting:
        description: 'Check code formatting with dotnet format'
        required: false
        type: boolean
        default: true
      fail-on-formatting-issues:
        description: 'Fail the build if formatting issues are detected'
        required: false
        type: boolean
        default: false

jobs:
  code-quality:
    name: Code Quality
    runs-on: ${{ inputs.runs-on }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: ./.github/actions/dotnet/setup
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
      
      - name: Restore dependencies
        uses: ./.github/actions/dotnet/restore
        with:
          working-directory: ${{ inputs.working-directory }}
      
      - name: Security vulnerability scan
        uses: ./.github/actions/security/vulnerability-scan
        with:
          working-directory: ${{ inputs.working-directory }}
          fail-on-severity: ${{ inputs.fail-on-severity }}
      
      - name: Validate test naming
        if: ${{ inputs.validate-test-naming }}
        uses: ./.github/actions/diagnostics/validate-test-naming
        with:
          test-directory: ${{ inputs.working-directory }}
      
      - name: Check formatting (warn only)
        if: ${{ inputs.check-formatting && !inputs.fail-on-formatting-issues }}
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          dotnet format --verify-no-changes --verbosity diagnostic || echo "::warning::Code formatting issues detected. Run 'dotnet format' to fix."
      
      - name: Check formatting (fail on issues)
        if: ${{ inputs.check-formatting && inputs.fail-on-formatting-issues }}
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          dotnet format --verify-no-changes --verbosity diagnostic
