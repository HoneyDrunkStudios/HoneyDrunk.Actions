name: Build and Test

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: 'The .NET SDK version to use'
        required: false
        type: string
        default: '10.0.x'
      configuration:
        description: 'Build configuration'
        required: false
        type: string
        default: 'Release'
      runs-on:
        description: 'The runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      working-directory:
        description: 'Working directory for build operations'
        required: false
        type: string
        default: '.'
      project-path:
        description: 'Path to solution or project file (auto-detected if not specified)'
        required: false
        type: string
        default: ''
      enable-cache:
        description: 'Enable NuGet package caching'
        required: false
        type: boolean
        default: true
      collect-coverage:
        description: 'Collect code coverage during tests'
        required: false
        type: boolean
        default: true
      actions-ref:
        description: 'Git ref of HoneyDrunk.Actions to use (should match the version of this workflow)'
        required: false
        type: string
        default: 'main'
    
    outputs:
      has-warnings:
        description: 'Whether warnings were detected'
        value: ${{ jobs.build-and-test.outputs.has-warnings }}
      warning-messages:
        description: 'List of warning messages'
        value: ${{ jobs.build-and-test.outputs.warning-messages }}

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ inputs.runs-on }}
    outputs:
      has-warnings: ${{ steps.check-warnings.outputs.has-warnings }}
      warning-messages: ${{ steps.check-warnings.outputs.warning-messages }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Checkout HoneyDrunk.Actions
        uses: actions/checkout@v4
        with:
          repository: HoneyDrunkStudios/HoneyDrunk.Actions
          path: .github/actions-repo
          ref: ${{ inputs.actions-ref }}
      
      - name: Setup .NET
        uses: ./.github/actions-repo/.github/actions/dotnet/setup
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
      
      - name: Setup NuGet cache
        if: ${{ inputs.enable-cache }}
        uses: ./.github/actions-repo/.github/actions/nuget/setup-cache
        with:
          working-directory: ${{ inputs.working-directory }}
      
      - name: Restore dependencies
        uses: ./.github/actions-repo/.github/actions/dotnet/restore
        with:
          working-directory: ${{ inputs.working-directory }}
          project-path: ${{ inputs.project-path }}
      
      - name: Build solution
        uses: ./.github/actions-repo/.github/actions/dotnet/build
        with:
          configuration: ${{ inputs.configuration }}
          no-restore: 'true'
          working-directory: ${{ inputs.working-directory }}
          project-path: ${{ inputs.project-path }}
      
      - name: Run tests
        id: run-tests
        uses: ./.github/actions-repo/.github/actions/dotnet/test
        with:
          configuration: ${{ inputs.configuration }}
          no-build: 'true'
          collect-coverage: ${{ inputs.collect-coverage }}
          working-directory: ${{ inputs.working-directory }}
          project-path: ${{ inputs.project-path }}
      
      - name: Publish test results
        if: always()
        uses: ./.github/actions-repo/.github/actions/diagnostics/publish-test-results
        with:
          test-results-directory: TestResults
      
      - name: Upload test results
        id: upload-tests
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.runs-on }}
          path: TestResults/**/*
          retention-days: 30
      
      - name: Upload coverage reports
        if: ${{ inputs.collect-coverage }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ inputs.runs-on }}
          path: TestResults/**/coverage.cobertura.xml
          retention-days: 30
      
      - name: Check for warnings
        id: check-warnings
        if: always()
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          HAS_WARNINGS="false"
          WARNINGS=""
          
          # Only warn about missing test results if tests were expected to run
          TESTS_FOUND="${{ steps.run-tests.outputs.tests-found }}"
          if [ "$TESTS_FOUND" = "true" ]; then
            # Check if test results directory exists and has .trx files
            if [ ! -d "TestResults" ] || [ -z "$(find TestResults -name '*.trx' 2>/dev/null)" ]; then
              HAS_WARNINGS="true"
              WARNINGS="Test projects found but no test result files were generated. Check test execution logs."
            fi
          fi
          
          echo "has-warnings=$HAS_WARNINGS" >> $GITHUB_OUTPUT
          echo "warning-messages=$WARNINGS" >> $GITHUB_OUTPUT
