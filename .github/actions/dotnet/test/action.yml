name: 'Test .NET Project'
description: 'Run tests for a .NET project with coverage and result reporting'
inputs:
  configuration:
    description: 'Build configuration'
    required: false
    default: 'Release'
  no-build:
    description: 'Skip build during test'
    required: false
    default: 'false'
  test-results-directory:
    description: 'Directory to store test results'
    required: false
    default: 'TestResults'
  collect-coverage:
    description: 'Collect code coverage'
    required: false
    default: 'true'
  working-directory:
    description: 'Working directory for tests'
    required: false
    default: '.'
  project-path:
    description: 'Path to a solution or project to test (optional)'
    required: false
    default: ''
runs:
  using: 'composite'
  steps:
    - name: Run tests
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        set -euo pipefail
        
        # Build common args
        ARGS="--configuration ${{ inputs.configuration }} --logger trx --results-directory ${{ inputs.test-results-directory }}"
        if [ "${{ inputs.no-build }}" == "true" ]; then
          ARGS="$ARGS --no-build"
        fi
        if [ "${{ inputs.collect-coverage }}" == "true" ]; then
          ARGS="$ARGS --collect \"XPlat Code Coverage\""
        fi
        
        TARGET="${{ inputs.project-path }}"
        if [ -n "$TARGET" ]; then
          echo "Running tests for explicit target: $TARGET"
          eval "dotnet test \"$TARGET\" $ARGS" && exit 0
        fi
        
        # Try a solution first (maxdepth 4 for consistency)
        SOLN=$(find . -maxdepth 4 \( -name "*.sln" -o -name "*.slnx" \) | head -n 1 || true)
        if [ -n "$SOLN" ]; then
          echo "Detected solution: $SOLN"
          eval "dotnet test \"$SOLN\" $ARGS" && exit 0
        fi
        
        # Discover test projects (maxdepth 4 for consistency with solution search)
        mapfile -t TEST_PROJECTS < <(find . -maxdepth 4 -name "*.csproj" -exec grep -l "Microsoft.NET.Test.Sdk\|MSTest.TestAdapter\|xunit\|nunit" {} \; || true)
        if [ ${#TEST_PROJECTS[@]} -eq 0 ]; then
          echo "No test projects found - skipping tests"
          exit 0
        fi
        
        echo "Discovered ${#TEST_PROJECTS[@]} test project(s). Running individually."
        FAIL=0
        for PROJ in "${TEST_PROJECTS[@]}"; do
          echo "Testing: $PROJ"
          if ! eval "dotnet test \"$PROJ\" $ARGS"; then
            FAIL=1
          fi
        done
        exit $FAIL
